# 代码规范

> 版本：v1.0  
> 更新日期：2026-01-09

## 1. 总体原则

### 1.1 核心理念
- KISS（Keep It Simple, Stupid）：保持简单，拒绝过度设计
- DRY（Don't Repeat Yourself）：消除重复代码
- YAGNI（You Aren't Gonna Need It）：不要实现当前不需要的功能
- 约定优于配置：遵循框架和社区约定

### 1.2 SOLID 原则
- 单一职责原则：一个类只做一件事
- 开闭原则：对扩展开放，对修改关闭
- 里氏替换原则：子类可以替换父类
- 接口隔离原则：接口要小而专一
- 依赖倒置原则：依赖抽象，不依赖具体实现

### 1.3 代码质量标准
- 可读性优先：代码是写给人看的，顺便给机器执行
- 自解释代码：好的命名胜过注释
- 单元可测试：每个模块都能独立测试
- 松散耦合：模块间通过接口通信，不直接依赖实现

---

## 2. 架构规范

### 2.1 分层架构
- API 层：只处理请求和响应，参数校验，不包含业务逻辑
- Service 层：业务逻辑，事务管理，调用多个 Repository
- Repository 层：数据访问，SQL 查询，不包含业务逻辑
- Model 层：数据结构定义

### 2.2 层间调用规则
- 只能上层调用下层：API → Service → Repository → Model
- 禁止跨层调用：API 不能直接调用 Repository
- 禁止反向依赖：Repository 不能调用 Service

### 2.3 依赖注入
- 所有依赖通过构造函数或参数注入
- 禁止在类内部直接实例化依赖
- 便于单元测试时 mock 依赖

### 2.4 接口抽象
- 对外部服务（AI、第三方 API）定义抽象接口
- 具体实现可替换（本地/云端）
- 通过配置选择具体实现

---

## 3. 命名规范

### 3.1 通用规则
- 使用有意义的英文命名，禁止拼音
- 名称要能表达意图，不需要注释解释
- 避免缩写，除非是广泛认可的（如 id、url、api）
- 保持命名风格一致

### 3.2 Python 命名
- 模块/文件：小写下划线（user_service.py）
- 类：大驼峰（UserService）
- 函数/方法/变量：小写下划线（get_user_info）
- 常量：大写下划线（MAX_RETRY_COUNT）
- 私有成员：单下划线前缀（_internal_cache）

### 3.3 TypeScript 命名
- 文件：短横线（user-service.ts）
- 组件：大驼峰（UserCard.vue）
- 函数/变量：小驼峰（getUserInfo）
- 常量：大写下划线（MAX_RETRY_COUNT）
- 类型/接口：大驼峰（UserInfo）

### 3.4 数据库命名
- 表名：小写下划线复数（users、device_logs）
- 字段：小写下划线（created_at、user_id）
- 索引：idx_表名_字段名（idx_users_email）

---

## 4. 代码风格

### 4.1 Python
- 遵循 PEP 8 规范
- 使用 Ruff 进行检查和格式化
- 行宽限制：120 字符
- 所有函数必须有类型注解
- 使用 async/await 处理 IO 操作

### 4.2 TypeScript
- 使用 ESLint + Prettier
- 行宽限制：100 字符
- 使用单引号，语句末尾不加分号
- 优先使用 const，其次 let，禁止 var
- 所有变量和函数必须有类型声明

### 4.3 通用
- 函数不超过 50 行
- 类不超过 300 行
- 文件不超过 500 行
- 嵌套不超过 3 层
- 参数不超过 5 个

---

## 5. 异常处理

### 5.1 异常分类
- 业务异常：可预期的业务错误，需要返回给用户
- 系统异常：不可预期的错误，需要记录日志

### 5.2 处理原则
- 定义统一的业务异常基类
- Service 层抛出业务异常
- API 层统一捕获并转换为 HTTP 响应
- 不要吞掉异常，至少要记录日志
- 异常信息要有足够上下文便于排查

---

## 6. API 设计

### 6.1 RESTful 规范
- 使用名词复数表示资源（/devices、/users）
- 使用 HTTP 方法表示操作（GET/POST/PUT/DELETE）
- 使用路径参数表示资源 ID（/devices/{id}）
- 使用查询参数表示过滤条件（?status=online）

### 6.2 版本管理
- URL 路径包含版本号（/api/v1/）
- 大版本变更才升级版本号
- 旧版本保持兼容一段时间

### 6.3 响应格式
- 统一的响应结构（code、message、data）
- 错误响应包含错误码和描述
- 列表响应包含分页信息

---

## 7. 注释规范

### 7.1 注释原则
- 注释是代码的说明书，要让不懂代码的人也能理解意图
- 宁可注释多一点，也不要让后来者猜测
- 注释要和代码同步更新，过时的注释比没有注释更糟糕

### 7.2 必须写注释的场景
- 文件头部：说明这个文件是做什么的，属于哪个模块
- 类/模块：说明职责、使用场景、依赖关系
- 公共函数/方法：说明功能、参数含义、返回值、可能的异常
- 复杂逻辑：解释为什么这样做，业务背景是什么
- 特殊处理：为什么要特殊处理，不处理会怎样
- 魔法数字：这个数字代表什么含义
- TODO/FIXME：标记待完成或待修复的内容，注明原因

### 7.3 注释内容要求
- 说明「为什么」而不只是「做什么」
- 用业务语言描述，而不是技术术语堆砌
- 包含足够的上下文，让人不用看其他代码就能理解
- 复杂算法要说明思路和步骤
- 涉及外部系统的要说明交互方式和注意事项

### 7.4 注释格式要求
- 文件头注释：作者、创建时间、文件描述
- 函数注释：功能描述、参数说明、返回值说明
- 行内注释：放在代码上方或右侧，解释关键逻辑
- 保持注释和代码的缩进一致
- 中文注释使用中文标点

---

## 8. Git 规范

### 8.1 分支命名
- main：主分支，生产环境
- develop：开发分支
- feature/xxx：功能分支
- bugfix/xxx：修复分支
- hotfix/xxx：紧急修复

### 8.2 Commit 格式
- feat：新功能
- fix：修复 bug
- docs：文档更新
- style：代码格式
- refactor：重构
- perf：性能优化
- test：测试相关
- chore：构建/工具

### 8.3 提交原则
- 每次提交只做一件事
- 提交信息要清晰描述改动内容
- 提交前确保代码能通过检查和测试

---

## 9. 测试规范

### 9.1 测试分类
- 单元测试：测试单个函数或类
- 集成测试：测试模块间交互
- E2E 测试：测试完整业务流程

### 9.2 测试原则
- 测试用例命名要描述场景和预期结果
- 每个测试只验证一个行为
- 测试之间相互独立，不依赖执行顺序
- 使用 mock 隔离外部依赖

---

## 10. 安全规范

### 10.1 敏感信息
- 密钥、密码等敏感信息不能硬编码
- 使用环境变量或配置中心管理
- 敏感信息不能出现在日志中
- 敏感信息不能提交到代码仓库

### 10.2 输入校验
- 所有外部输入都要校验
- 使用白名单而非黑名单
- 防止 SQL 注入、XSS 等攻击

### 10.3 权限控制
- 接口要有权限校验
- 遵循最小权限原则
- 敏感操作要有审计日志
