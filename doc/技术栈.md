<!--
 * @Author: 星年 && j_xingnian@163.com
 * @Date: 2026-01-09 09:21:34
 * @LastEditors: xingnian j_xingnian@163.com
 * @LastEditTime: 2026-01-09 09:33:13
 * @FilePath: \xn_smart_dialogue_platform\doc\技术栈.md
 * @Description: 
 * 
 * Copyright (c) 2026 by ${git_name_email}, All Rights Reserved. 
-->
# 知境中枢 - 技术栈文档

> 版本：v1.0  
> 更新日期：2026-01-09

## 1. 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                    管理端 (Vue3)                         │
└─────────────────────────┬───────────────────────────────┘
                          │ HTTPS
┌─────────────────────────▼───────────────────────────────┐
│                   知境中枢 (FastAPI)                     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │   记忆层    │  │   决策层    │  │   设备层    │     │
│  │  pgvector   │  │  LLM/NLU   │  │    MQTT     │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────┬───────────────────────────────┘
                          │ MQTT
┌─────────────────────────▼───────────────────────────────┐
│                设备端 (ESP32/树莓派)                     │
│         净化器  │  喂鱼器  │  其他设备...               │
└─────────────────────────────────────────────────────────┘
```

## 2. 后端技术栈

### 2.1 核心框架
| 技术 | 版本 | 用途 |
|------|------|------|
| Python | 3.11+ | 主开发语言 |
| FastAPI | 0.109+ | Web 框架 |
| Uvicorn | 0.27+ | ASGI 服务器 |
| Pydantic | 2.x | 数据校验 |

### 2.2 数据存储
| 技术 | 版本 | 用途 |
|------|------|------|
| PostgreSQL | 16+ | 主数据库 |
| pgvector | 0.6+ | 向量存储（文本/图像记忆） |
| Redis | 7.x | 缓存/会话/消息队列 |
| MinIO | latest | 本地图像/视频文件存储 |

### 2.3 AI 能力
| 技术 | 用途 |
|------|------|
| 通义千问 API | 对话、语音识别、TTS |
| Qwen-VL API | 图像理解、场景识别 |
| Qwen-Audio API | 音频理解 |
| 文本 Embedding 模型 | 文本向量化（本地记忆检索） |
| 图像 Embedding 模型 | 图像向量化（CLIP 等） |
| 人脸识别模型 | 人脸特征提取（InsightFace） |
| Ollama (可选) | 本地模型部署 |

### 2.4 设备通信
| 技术 | 用途 |
|------|------|
| EMQX / Mosquitto | MQTT Broker |
| aiomqtt | Python MQTT 客户端 |

### 2.5 其他依赖
| 技术 | 用途 |
|------|------|
| SQLAlchemy | ORM |
| Alembic | 数据库迁移 |
| Celery | 异步任务队列 |
| Loguru | 日志管理 |

## 3. 前端技术栈（管理端）

| 技术 | 版本 | 用途 |
|------|------|------|
| Vue | 3.4+ | 前端框架 |
| TypeScript | 5.x | 开发语言 |
| Vite | 5.x | 构建工具 |
| Element Plus | 2.x | UI 组件库 |
| Pinia | 2.x | 状态管理 |
| Vue Router | 4.x | 路由管理 |
| Axios | 1.x | HTTP 客户端 |
| ECharts | 5.x | 数据可视化 |

## 4. 设备端技术栈

### 4.1 ESP32 方案（净化器/喂鱼器）
| 技术 | 用途 |
|------|------|
| ESP-IDF / Arduino | 开发框架 |
| PubSubClient | MQTT 客户端 |
| ArduinoJson | JSON 解析 |
| FreeRTOS | 实时操作系统 |

### 4.2 树莓派方案（高级设备）
| 技术 | 用途 |
|------|------|
| Python 3.11+ | 开发语言 |
| paho-mqtt | MQTT 客户端 |
| RPi.GPIO | GPIO 控制 |
| OpenCV | 图像采集 |

## 5. 部署技术栈

| 技术 | 用途 |
|------|------|
| Docker | 容器化 |
| Docker Compose | 本地编排 |
| Nginx | 反向代理/静态资源 |
| Let's Encrypt | SSL 证书 |

## 6. 开发工具

| 工具 | 用途 |
|------|------|
| Git | 版本控制 |
| pytest | 单元测试 |
| Ruff | 代码检查/格式化 |
| pre-commit | Git 钩子 |

## 7. 项目目录结构

```
xn_smart_dialogue_platform/
├── backend/                    # 后端服务
│   ├── app/
│   │   ├── api/               # API 路由
│   │   │   ├── v1/
│   │   │   │   ├── device.py  # 设备接口
│   │   │   │   ├── memory.py  # 记忆接口
│   │   │   │   └── chat.py    # 对话接口
│   │   ├── core/              # 核心配置
│   │   │   ├── config.py
│   │   │   └── security.py
│   │   ├── services/          # 业务逻辑
│   │   │   ├── memory/        # 记忆服务
│   │   │   │   ├── local/     # 本地记忆
│   │   │   │   │   ├── text.py      # 文本记忆（对话、感知）
│   │   │   │   │   ├── preference.py # 偏好习惯记忆
│   │   │   │   │   └── image.py     # 图像记忆（人脸、视频帧）
│   │   │   │   └── external/  # 外部记忆
│   │   │   │       ├── album.py     # AI 相册 API
│   │   │   │       └── knowledge.py # 外部知识库
│   │   │   ├── decision/      # 决策服务
│   │   │   ├── device/        # 设备服务
│   │   │   └── ai/            # AI 能力封装
│   │   │       ├── embedding.py     # 向量化服务
│   │   │       ├── face.py          # 人脸识别
│   │   │       └── llm.py           # 大模型调用
│   │   ├── models/            # 数据模型
│   │   └── main.py
│   ├── tests/
│   ├── alembic/               # 数据库迁移
│   ├── requirements.txt
│   └── Dockerfile
├── admin-web/                  # 管理端前端
│   ├── src/
│   │   ├── views/
│   │   ├── components/
│   │   ├── stores/
│   │   └── api/
│   ├── package.json
│   └── Dockerfile
├── device/                     # 设备端代码
│   ├── esp32/
│   │   ├── purifier/          # 净化器
│   │   └── fish_feeder/       # 喂鱼器
│   └── raspberry/
├── deploy/                     # 部署配置
│   ├── docker-compose.yml
│   └── nginx.conf
└── doc/                        # 文档
    ├── 功能需求.md
    ├── 技术栈.md
    └── 平台架构.drawio
```

## 8. 环境要求

### 8.1 开发环境
- Python 3.11+
- Node.js 20+
- Docker Desktop
- VS Code / Kiro

### 8.2 生产环境
- Linux (Ubuntu 22.04+ / Debian 12+)
- 2核4G 起步（小规模）
- 4核8G 推荐（中等规模）
