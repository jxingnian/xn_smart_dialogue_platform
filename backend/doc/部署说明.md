# 知境中枢 - 后端服务部署说明

## 技术栈

- Python 3.11+
- FastAPI
- PostgreSQL + pgvector
- Redis
- MQTT (EMQX)

## 环境要求

- Python 3.11+
- PostgreSQL 16+（需安装 pgvector 扩展）
- Redis 7+
- EMQX 5+（MQTT Broker）

## 本地开发

1. 进入后端目录
```bash
cd backend
```

2. 创建虚拟环境
```bash
python -m venv venv
# Windows
venv\Scripts\activate
# Linux/Mac
source venv/bin/activate
```

3. 安装依赖
```bash
pip install -r requirements.txt
```

4. 配置环境变量
```bash
cp .env.example .env
# 编辑 .env 文件，填写数据库、Redis、MQTT 等配置
```

5. 初始化数据库
```bash
# 创建数据库
psql -U postgres -c "CREATE DATABASE zhijing;"
# 安装 pgvector 扩展
psql -U postgres -d zhijing -c "CREATE EXTENSION vector;"
# 执行数据库迁移
alembic upgrade head
```

6. 启动服务
```bash
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

7. 访问 API 文档
```
http://localhost:8000/docs
```

## Docker 部署

1. 构建镜像
```bash
docker build -t zhijing-backend .
```

2. 运行容器
```bash
docker run -d \
  --name zhijing-backend \
  -p 8000:8000 \
  -e DATABASE_URL=postgresql+asyncpg://postgres:postgres@host.docker.internal:5432/zhijing \
  -e REDIS_URL=redis://host.docker.internal:6379/0 \
  -e MQTT_BROKER=host.docker.internal \
  zhijing-backend
```

## 环境变量说明

| 变量名 | 说明 | 默认值 |
|--------|------|--------|
| DATABASE_URL | PostgreSQL 连接地址 | postgresql+asyncpg://postgres:postgres@localhost:5432/zhijing |
| REDIS_URL | Redis 连接地址 | redis://localhost:6379/0 |
| MQTT_BROKER | MQTT Broker 地址 | localhost |
| MQTT_PORT | MQTT Broker 端口 | 1883 |
| DASHSCOPE_API_KEY | 通义千问 API Key | - |
| OLLAMA_BASE_URL | Ollama 服务地址 | http://localhost:11434 |
| SECRET_KEY | JWT 密钥 | 必须修改 |
| DEBUG | 调试模式 | true |

## API 接口

启动服务后访问 `http://localhost:8000/docs` 查看完整的 API 文档。

主要接口：
- `/api/v1/devices` - 设备管理
- `/api/v1/memories` - 记忆管理
- `/api/v1/chat` - 对话交互
- `/health` - 健康检查
